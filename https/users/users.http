### Environment variables
# Define these variables at the top so your HTTP client (VSCode REST Client, Thunder Client, etc.) can resolve them.
@usersHost = http://localhost:3011
@authHost = http://localhost:3010

# Base URLs
@apiBaseUsers = {{usersHost}}
@apiBaseAuth = {{authHost}}
@userId = 1

# Capture tokens from the local `loginUsers` request (defined below) so this file
# can be used standalone without running `auth.http`. If you prefer, you can still
# run the `auth.http` login and adjust these vars to `{{login.response.body.$.accessToken}}`.
@token = {{loginUsers.response.body.$.accessToken}}
@refreshToken = {{loginUsers.response.body.$.refreshToken}}

# Service token for internal API calls (set to match your .env SERVICE_TOKEN)
@serviceToken = Utfpr@2005

### Local helper: login (named `loginUsers`)
# @name loginUsers
POST {{apiBaseAuth}}/auth/login
Accept: application/json
Content-Type: application/json

{
  "email": "test.user@example.com",
  "password": "StrongP@ssw0rd"
}

### Local helper: logout (named `logoutUsers`)
# @name logoutUsers
POST {{apiBaseAuth}}/auth/logout
Accept: application/json
Content-Type: application/json

{
  "refreshToken": "{{refreshToken}}"
}

### POST /users/validate (used by Auth service)
POST {{apiBaseUsers}}/users/validate
Accept: application/json
Content-Type: application/json

{
  "email": "test.user@example.com",
  "password": "StrongP@ssw0rd"
}

### POST /users/validate with service token (for internal calls)
POST {{apiBaseUsers}}/users/validate
Accept: application/json
Content-Type: application/json
x-service-token: {{serviceToken}}

{
  "email": "test.user@example.com",
  "password": "StrongP@ssw0rd"
}

### List users (REQUIRES teacher|admin)
GET {{apiBaseUsers}}/users?q=ana&role=teacher&isActive=true&page=1&limit=20
Accept: application/json
Authorization: Bearer {{token}}

### Get user by id (REQUIRES self-or-admin)
GET {{apiBaseUsers}}/users/{{userId}}
Accept: application/json
Authorization: Bearer {{token}}

### Create user (REQUIRES admin)
POST {{apiBaseUsers}}/users
Accept: application/json
Content-Type: application/json
Authorization: Bearer {{token}}

{
  "name": "Test User",
  "email": "test.user@example.com",
  "password": "StrongP@ssw0rd",
  "role": "teacher"
  // NOTE: If your Users API expects roles as an array (recommended with JWT canônico), use instead:
  // "roles": ["student"]
}

### Create student user (for testing)
POST {{apiBaseUsers}}/users
Accept: application/json
Content-Type: application/json
Authorization: Bearer {{token}}

{
  "name": "Student User",
  "email": "student.user@example.com",
  "password": "StudentP@ss1",
  "role": "student"
  // NOTE: If your Users API expects roles as an array, use:
  // "roles": ["student"]
}


### Create admin user (for testing)
POST {{apiBaseUsers}}/users
Accept: application/json
Content-Type: application/json
Authorization: Bearer {{token}}

{
  "name": "Admin User",
  "email": "admin.user@example.com",
  "password": "AdminP@ss1",
  "role": "admin"
  // NOTE: If your Users API expects roles as an array, use:
  // "roles": ["admin"]
}


### Update user (partial) (REQUIRES self-or-admin)
PATCH {{apiBaseUsers}}/users/{{userId}}
Accept: application/json
Content-Type: application/json
Authorization: Bearer {{token}}

{
  "name": "Updated Name"
  // NOTE: When acting as "self", limit updatable fields (e.g., name). Admin may update broader fields per policy.
}

### Replace user (PUT) (REQUIRES self-or-admin)
PUT {{apiBaseUsers}}/users/{{userId}}
Accept: application/json
Content-Type: application/json
Authorization: Bearer {{token}}

{
  "name": "Replaced Name",
  "email": "replaced.user@example.com",
  "password": "AnotherP@ss1",
  "role": "teacher"
  // NOTE: If your schema uses roles array:
  // "roles": ["student"]
}

### Delete user (REQUIRES admin)
DELETE {{apiBaseUsers}}/users/{{userId}}
Accept: application/json
Authorization: Bearer {{token}}

# Notes
# - Set `@token` to a valid JWT (or enable automatic capture from Auth). Protected routes return 401 without a token.
# - Query params for `GET /users`: `q` (text search in name/email), `role`, `isActive` (true/false), `page`, `limit`.
# - RBAC esperado:
#   • GET /users → teacher|admin
#   • GET /users/:id → self-or-admin (self = params.id === JWT.sub)
#   • POST /users → admin
#   • PATCH/PUT /users/:id → self-or-admin (service enforces field limits for self)
#   • DELETE /users/:id → admin
# - `POST /users/validate` is used by the Auth service to verify credentials and should return the user identity when successful.
# - Adjust `@usersHost` and `@authHost` if your servers run on different ports or hosts.
#   By default user endpoints use `{{apiBaseUsers}}` and auth endpoints use `{{apiBaseAuth}}`.
