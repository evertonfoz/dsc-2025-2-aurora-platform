# Este arquivo de configuração do Nginx é um template.
# Os valores de '$DOMAIN' e os caminhos dos certificados SSL são pensados
# para serem preenchidos pelo Certbot ou por um script de inicialização.

# Bloco 1: Servidor HTTP (Porta 80)
# - Redireciona todo o tráfego HTTP para HTTPS.
# - Usado pelo Certbot para o desafio ACME.
server {
    listen 80;
    # IMPORTANTE: Substitua 'example.com' pelo seu domínio real.
    server_name $DOMAIN www.$DOMAIN;

    # Rota para o desafio do Let's Encrypt (ACME Challenge)
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    # Para todas as outras requisições, redireciona para HTTPS.
    location / {
        return 301 https://$host$request_uri;
    }
}

# Bloco 2: Servidor HTTPS (Porta 443)
# - Lida com todo o tráfego seguro da aplicação.
# - Atua como proxy reverso para os microsserviços.
server {
    listen 443 ssl;
    # IMPORTANTE: Substitua 'example.com' pelo seu domínio real.
    server_name $DOMAIN www.$DOMAIN;

    # Caminhos para os certificados SSL (serão gerenciados pelo Certbot)
    ssl_certificate /etc/letsencrypt/live/$DOMAIN/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/$DOMAIN/privkey.pem;
    
    # Configurações de SSL recomendadas para segurança
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    # Configurações de proxy
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_read_timeout 90s;

    # Roteamento para os microsserviços baseado no caminho da URL
    
    # Exemplo: https://<domain>/auth/... -> auth-service:3010
    location /auth/ {
        proxy_pass http://auth-service:3010;
    }

    # Exemplo: https://<domain>/users/... -> users-service:3011
    location /users/ {
        proxy_pass http://users-service:3011;
    }

    # Exemplo: https://<domain>/events/... -> events-service:3012
    location /events/ {
        proxy_pass http://events-service:3012;
    }
    
    # Rota raiz (opcional, pode mostrar uma página de status ou ser um dos serviços)
    location / {
        # Por padrão, podemos redirecionar para um dos serviços ou retornar um status.
        # Aqui, apenas um status 200 OK com uma mensagem.
        return 200 'Aurora Platform is running.';
        add_header Content-Type text/plain;
    }
}
